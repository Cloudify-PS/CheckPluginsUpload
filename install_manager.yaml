tosca_definitions_version: cloudify_dsl_1_3

imports:
  - http://www.getcloudify.org/spec/cloudify/4.3.1/types.yaml
  - https://raw.githubusercontent.com/cloudify-incubator/cloudify-utilities-plugin/1.8.2/plugin.yaml

inputs:

  manager_user:
    type: string
    default: centos
    description: >
      Manager user name.

  manager_key:
    type: string
    description: >
      Manager key.

  manager_host:
    type: string
    description: >
      Manager public ip.

  manager_privateip:
    type: string
    description: >
      Manager private ip.

  manager_cloudify_password:
    type: string
    default: admin
    description: >
      Manager cloudify password.

  manager_package:
    type: string
    default: 4.4.0/rc1-release/cloudify-manager-install-4.4rc1.rpm
    description: >
      Manager package.

node_templates:

  manager_install:
    type: cloudify.terminal.raw
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            terminal_auth:
              user: { get_input: manager_user }
              ip: { get_input: manager_host }
              key_content: { get_input: manager_key }
              port: 22
              promt_check:
                - '#'
                - '$'
            calls:
              - action: {concat:["sudo rpm -i http://repository.cloudifysource.org/cloudify/", { get_input: manager_package }]}
              - action: {concat:["cfy_manager install --private-ip ", { get_input: manager_privateip }, " --public-ip ", { get_input: manager_host }, " -a ", { get_input: manager_cloudify_password }]}
              - action: cfy plugins bundle-upload
